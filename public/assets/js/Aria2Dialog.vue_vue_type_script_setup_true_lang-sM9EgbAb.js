import{v as J,x as W,y as j,g as i,d as H,z as K,A as X,B as Q,b as g,n as O,C as Y,D as Z,E as ee,G as ae,H as te,I as ne,J as le,K as se,L as oe,N as ie,O as re,P as ue,Q as ce,R as de,q,a as fe,S as ve,T as ge,M as _,U as M,V as me,s as pe,e as _e,f as S,W as Ce,j as L,i as T,o as he}from"./index-DROaSmUE.js";import{f as we}from"./format-B7KtlDMn.js";import{D as ke}from"./index-B1Lok1zU.js";import{a as Fe,F as Ie}from"./index-DyToNxRB.js";import{I as ye,S as Se}from"./index-DYAV7n9i.js";import{B as Le}from"./useResizeObserver-kPcrbMcO.js";/**
 * tdesign v1.11.5
 * (c) 2025 tdesign
 * @license MIT
 */function xe(){var s=W();return function(f,m){var w;if(J(s.props[f]))w=s.props[f](j);else if(s.slots[f])w=s.slots[f]&&s.slots[f](null)[0];else if(m){var n=m[s.props.theme];w=i(n,null,null)}return w}}/**
 * tdesign v1.11.5
 * (c) 2025 tdesign
 * @license MIT
 */var Ae={close:{type:[String,Boolean,Function],default:!1},default:{type:[String,Function]},icon:{type:Function},maxLine:{type:Number,default:0},message:{type:[String,Function]},operation:{type:Function},theme:{type:String,default:"info",validator:function(t){return["success","info","warning","error"].includes(t)}},title:{type:[String,Function]},onClose:Function,onClosed:Function};/**
 * tdesign v1.11.5
 * (c) 2025 tdesign
 * @license MIT
 */var be=H({name:"TAlert",props:Ae,setup:function(t){var f=K("alert"),m=f.globalConfig,w=f.classPrefix,n=X({CheckCircleFilledIcon:ie,CloseIcon:oe,ErrorCircleFilledIcon:se,HelpCircleFilledIcon:le,InfoCircleFilledIcon:ne}),x=n.CheckCircleFilledIcon,r=n.CloseIcon,I=n.ErrorCircleFilledIcon,p=n.HelpCircleFilledIcon,h=n.InfoCircleFilledIcon,l=Q("alert"),u=re(),c=xe(),o=g(null),k=g(null),v=g(0),F=g(!0),d=g(!0),b=function(){var e={info:h,success:x,warning:I,error:I,question:p},a=c("icon",e);return a?i("div",{class:"".concat(l.value,"__icon")},[a]):null},N=function(){var e=t.close,a=null;return e===!0||e===""?a=i(r,null,null):te(e)?a=e:a=c("close"),a?i("div",{class:"".concat(l.value,"__close"),onClick:G},[a]):null},D=function(){var e=u("title");return e?i("div",{class:"".concat(l.value,"__title")},[" ",e]):null},P=function(){var e=u("operation");return i("div",{class:"".concat(l.value,"__message")},[V(),e?i("div",{class:"".concat(l.value,"__operation")},[e]):null])},V=function(){var e,a;a=u("default"),a||(a=u("message"));var C=ue(a)?a.length:1,A=t.maxLine>0&&t.maxLine<C,z=(e=k.value)===null||e===void 0||(e=e.children[0])===null||e===void 0?void 0:e.offsetHeight;return A&&d.value?(a=a.slice(0,t.maxLine),z&&(k.value.style.height="".concat(v.value,"px"))):A&&z&&(k.value.style.height="".concat(z*(C-t.maxLine)+v.value,"px")),i("div",{class:"".concat(l.value,"__description"),ref:k},[A?a.map(function(R){return i("div",null,[R])}):a,A?i("div",{class:"".concat(l.value,"__collapse"),onClick:function(){d.value=!d.value}},[d.value?m.value.expandText:m.value.collapseText]):null])},E=function(){return i("div",{class:"".concat(l.value,"__content")},[D(),P()])},G=function(e){var a;(a=t.onClose)===null||a===void 0||a.call(t,{e}),ce(o.value,"".concat(l.value,"--closing"))},$=function(e){var a=e.target===o.value;if(e.propertyName==="opacity"&&a){var C;F.value=!1,(C=t.onClosed)===null||C===void 0||C.call(t,{e})}};return O(function(){Y(o.value,"transitionend",$),v.value=k.value.offsetHeight}),Z(function(){ee(o.value,"transitionend",$)}),function(){return i("div",{ref:o,class:["".concat(l.value),"".concat(l.value,"--").concat(t.theme),ae({},"".concat(w.value,"-is-hidden"),!F.value)]},[b(),E(),N()])}}});/**
 * tdesign v1.11.5
 * (c) 2025 tdesign
 * @license MIT
 */var Te=de(be);const U=fe(),Ve=q("fileList",()=>{const s=g({url:"",surl:"",pwd:"",dir:"/",parse_password:""}),t=g(),f=g([]),m=()=>f.value.length===0?"/":f.value[f.value.length-2]??"/",w=async()=>{p.value=[];const v=await ve(s.value);t.value=v.data,s.value.dir!=="/"?t.value.list.unshift({category:-1,fs_id:0,is_dir:!0,local_ctime:0,local_mtime:0,server_ctime:0,server_mtime:0,size:0,md5:"",path:m(),server_filename:"返回上一层",dlink:""}):f.value=[]},n=g({token:localStorage.getItem("token")??"guest"}),x=g({count:0,size:0,expires_at:"1970-01-01 08:00:00"}),r=g(""),I=async()=>{var v,F;try{const d=await ge(n.value);x.value=d.data,r.value="",localStorage.setItem("token",n.value.token)}catch(d){const b=(F=(v=d==null?void 0:d.response)==null?void 0:v.data)==null?void 0:F.message;b&&(r.value=b)}},p=g([]),h=g([]),l=(v,F)=>{p.value=v,h.value=F.selectedRowData},u=g({hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""}),c=g(!1),o=g([]);return{GetFileListReq:s,GetFileListRes:t,getFileList:w,GetLimitReq:n,GetLimitRes:x,GetLimitError:r,getLimit:I,selectedRowKeys:p,handleSelectChange:l,getDownloadLinks:async(v,F)=>{var G,$,y;if(c.value)return _.error("正在解析中,请稍后再试"),!1;const{config:d}=U;v&&typeof v!="number"&&F&&(v.stopPropagation(),h.value=[F]);const b=[],N=h.value.filter(e=>(e.is_dir&&b.push(e.fs_id),e&&!e.is_dir));N.length!==h.value.length&&_.warning("暂时不支持解析文件夹"),h.value=N,p.value=p.value.filter(e=>!b.includes(e));const D=N.filter(e=>e.size>d.min_single_filesize);D.length!==N.length&&_.warning("文件过小不会被解析");const P=D.filter(e=>e.size<d.max_single_filesize);P.length!==D.length&&_.warning("文件过大不会被解析");const V=P;if(V.reduce((e,a)=>e+a.size,0)>d.max_all_filesize){_.error(`单次最多解析${we(d.max_all_filesize)}的文件`);return}if(V.length>d.max_once){_.error(`单次最多解析${d.max_once}个文件`);return}if(V.length===0){_.error("满足要求的文件数量为0");return}try{if(c.value=!0,u.value.hit_captcha=!1,typeof v=="number"){const e=await M({randsk:t.value.randsk,uk:t.value.uk,shareid:t.value.shareid,fs_id:[v],surl:s.value.surl,dir:s.value.dir,pwd:s.value.pwd,token:n.value.token,parse_password:s.value.parse_password,vcode_str:u.value.vcode_str,vcode_input:u.value.vcode_input});return _.success("重新解析成功"),e.data}else{const e=[];let a=null,C;try{for(const A in V){C=V[A],a&&a.close(),a=await _.loading(`正在解析第${parseFloat(A)+1}个文件:${C.server_filename}`,9999999);const z=await M({randsk:t.value.randsk,uk:t.value.uk,shareid:t.value.shareid,fs_id:[C.fs_id],surl:s.value.surl,dir:s.value.dir,pwd:s.value.pwd,token:n.value.token,parse_password:s.value.parse_password,vcode_str:u.value.vcode_str,vcode_input:u.value.vcode_input});e.push(...z.data),C!==null&&(p.value=p.value.filter(R=>R!==C.fs_id),h.value=h.value.filter(R=>R.fs_id!==C.fs_id))}}catch(A){throw a&&a.close(),o.value=e,_.success("部分解析成功,下滑查看解析结果"),A}a&&a.close(),_.success("解析成功,下滑查看解析结果"),o.value=e}}catch(e){const a=e;if((y=($=(G=a==null?void 0:a.response)==null?void 0:G.data)==null?void 0:$.message)!=null&&y.includes("-20")){const C=await me({parse_password:s.value.parse_password});u.value={hit_captcha:!0,...C.data,vcode_input:""}}else _.error("解析可能失败或超时了,请稍后前往历史记录中尝试查询是否成功")}finally{c.value=!1,await I(),await U.getConfig()}},GetDownLoadLinksRes:o,vcode:u,paths:f}}),B=Ve(),Ne=q("aria2",()=>{const s=g(!1),t=g({host:"ws://localhost:16800/jsonrpc",token:"",dir:""});O(()=>{const l=localStorage.getItem("aria2Config");l&&(t.value=JSON.parse(l))});const f=()=>s.value=!0,m=()=>s.value=!1,w=()=>{localStorage.setItem("aria2Config",JSON.stringify(t.value)),n=null};let n=null;const x=()=>new Promise((l,u)=>{n&&(n.close(),n=null);try{n=new WebSocket(t.value.host),n.onopen=()=>l(n),n.onerror=c=>{_.error("链接到Aria2下载器出错"),u(c)}}catch(c){_.error("链接到Aria2下载器出错"),u(c)}}),r=async(l,u=[])=>((!n||n.readyState!==WebSocket.OPEN)&&(n=await x()),new Promise((c,o)=>{n=n;const k="HkList"+Date.now().toString(),v={jsonrpc:"2.0",method:l,id:k,params:[`token:${t.value.token}`,...u]};n.onmessage=F=>{const d=JSON.parse(F.data);d.id===k&&(d.error?o(d.error):c(d.result))},n.send(JSON.stringify(v))})),I=async()=>{await r("aria2.getVersion"),_.success("测试连接成功")},p=async(l,u,c,o)=>{await r("aria2.addUri",[[l],{out:u,dir:t.value.dir===""?null:t.value.dir,header:[`User-Agent: ${c}`],split:o.toString()}]),_.success("添加链接成功")};return{aria2ConfigDialogVisible:s,showAria2Config:f,hideAria2Config:m,aria2ConfigForm:t,saveAria2Config:w,getAria2Version:I,addAria2Url:p,downloadLinks:async(l,u=0)=>{Array.isArray(l)||(l=[l]);for(const c of l){let o=c.filename;if(c.fs_id&&B.GetFileListRes){const k=B.GetFileListRes.list.find(v=>v.fs_id===c.fs_id);k&&(o=k.path)}await p(c.urls[u],o,c.ua,16)}}}}),Ee=H({__name:"Aria2Dialog",setup(s){const t=Ne(),{aria2ConfigDialogVisible:f,aria2ConfigForm:m}=pe(t),w={},n=async({validateResult:x})=>{x===!0&&(t.saveAria2Config(),t.hideAria2Config(),_.success("保存成功"))};return(x,r)=>{const I=ye,p=Fe,h=Le,l=Se,u=Ie,c=ke;return he(),_e(c,{visible:L(f),"onUpdate:visible":r[3]||(r[3]=o=>Ce(f)?f.value=o:null),header:"Aria2配置调整",footer:!1},{default:S(()=>[i(u,{data:L(m),rules:w,onSubmit:n},{default:S(()=>[i(p,{label:"主机地址",name:"host",help:"需要包括协议,端口,地址"},{default:S(()=>[i(I,{modelValue:L(m).host,"onUpdate:modelValue":r[0]||(r[0]=o=>L(m).host=o)},null,8,["modelValue"])]),_:1}),i(p,{label:"密钥",name:"token"},{default:S(()=>[i(I,{modelValue:L(m).token,"onUpdate:modelValue":r[1]||(r[1]=o=>L(m).token=o)},null,8,["modelValue"])]),_:1}),i(p,{label:"保存路径",name:"dir"},{default:S(()=>[i(I,{modelValue:L(m).dir,"onUpdate:modelValue":r[2]||(r[2]=o=>L(m).dir=o)},null,8,["modelValue"])]),_:1}),i(p,null,{default:S(()=>[i(l,{size:"small"},{default:S(()=>[i(h,{theme:"default",onClick:L(t).hideAria2Config},{default:S(()=>r[4]||(r[4]=[T(" 取消 ")])),_:1},8,["onClick"]),i(h,{onClick:L(t).getAria2Version},{default:S(()=>r[5]||(r[5]=[T(" 测试连接 ")])),_:1},8,["onClick"]),i(h,{type:"submit"},{default:S(()=>r[6]||(r[6]=[T(" 保存 ")])),_:1})]),_:1})]),_:1})]),_:1},8,["data"])]),_:1},8,["visible"])}}});export{Te as A,Ee as _,Ne as a,Ve as u};
