import{v as W,x as j,y as K,g as i,d as H,z as X,A as Q,B as Y,b as g,n as O,C as Z,D as ee,E as ae,G as ne,H as te,I as le,J as se,K as oe,L as ie,N as re,O as ue,P as ce,Q as de,R as fe,q,a as J,S as ve,T as ge,M as _,U as M,V as me,s as pe,e as _e,f as y,W as Ce,j as L,i as T,o as he}from"./index-CT8Ulp4D.js";import{f as ke}from"./format-ChiTFvrx.js";import{D as we}from"./index-DJEJmBF5.js";import{a as Fe,F as Ie}from"./index-rECq69LH.js";import{I as Se,S as ye}from"./index-DgNX2Ncn.js";import{B as Le}from"./useResizeObserver-CV0gsgmI.js";/**
 * tdesign v1.11.5
 * (c) 2025 tdesign
 * @license MIT
 */function xe(){var s=j();return function(f,m){var k;if(W(s.props[f]))k=s.props[f](K);else if(s.slots[f])k=s.slots[f]&&s.slots[f](null)[0];else if(m){var t=m[s.props.theme];k=i(t,null,null)}return k}}/**
 * tdesign v1.11.5
 * (c) 2025 tdesign
 * @license MIT
 */var Ae={close:{type:[String,Boolean,Function],default:!1},default:{type:[String,Function]},icon:{type:Function},maxLine:{type:Number,default:0},message:{type:[String,Function]},operation:{type:Function},theme:{type:String,default:"info",validator:function(n){return["success","info","warning","error"].includes(n)}},title:{type:[String,Function]},onClose:Function,onClosed:Function};/**
 * tdesign v1.11.5
 * (c) 2025 tdesign
 * @license MIT
 */var be=H({name:"TAlert",props:Ae,setup:function(n){var f=X("alert"),m=f.globalConfig,k=f.classPrefix,t=Q({CheckCircleFilledIcon:re,CloseIcon:ie,ErrorCircleFilledIcon:oe,HelpCircleFilledIcon:se,InfoCircleFilledIcon:le}),x=t.CheckCircleFilledIcon,r=t.CloseIcon,I=t.ErrorCircleFilledIcon,p=t.HelpCircleFilledIcon,h=t.InfoCircleFilledIcon,l=Y("alert"),u=ue(),c=xe(),o=g(null),w=g(null),v=g(0),F=g(!0),d=g(!0),b=function(){var e={info:h,success:x,warning:I,error:I,question:p},a=c("icon",e);return a?i("div",{class:"".concat(l.value,"__icon")},[a]):null},$=function(){var e=n.close,a=null;return e===!0||e===""?a=i(r,null,null):te(e)?a=e:a=c("close"),a?i("div",{class:"".concat(l.value,"__close"),onClick:G},[a]):null},R=function(){var e=u("title");return e?i("div",{class:"".concat(l.value,"__title")},[" ",e]):null},P=function(){var e=u("operation");return i("div",{class:"".concat(l.value,"__message")},[V(),e?i("div",{class:"".concat(l.value,"__operation")},[e]):null])},V=function(){var e,a;a=u("default"),a||(a=u("message"));var C=ce(a)?a.length:1,A=n.maxLine>0&&n.maxLine<C,z=(e=w.value)===null||e===void 0||(e=e.children[0])===null||e===void 0?void 0:e.offsetHeight;return A&&d.value?(a=a.slice(0,n.maxLine),z&&(w.value.style.height="".concat(v.value,"px"))):A&&z&&(w.value.style.height="".concat(z*(C-n.maxLine)+v.value,"px")),i("div",{class:"".concat(l.value,"__description"),ref:w},[A?a.map(function(N){return i("div",null,[N])}):a,A?i("div",{class:"".concat(l.value,"__collapse"),onClick:function(){d.value=!d.value}},[d.value?m.value.expandText:m.value.collapseText]):null])},E=function(){return i("div",{class:"".concat(l.value,"__content")},[R(),P()])},G=function(e){var a;(a=n.onClose)===null||a===void 0||a.call(n,{e}),de(o.value,"".concat(l.value,"--closing"))},D=function(e){var a=e.target===o.value;if(e.propertyName==="opacity"&&a){var C;F.value=!1,(C=n.onClosed)===null||C===void 0||C.call(n,{e})}};return O(function(){Z(o.value,"transitionend",D),v.value=w.value.offsetHeight}),ee(function(){ae(o.value,"transitionend",D)}),function(){return i("div",{ref:o,class:["".concat(l.value),"".concat(l.value,"--").concat(n.theme),ne({},"".concat(k.value,"-is-hidden"),!F.value)]},[b(),E(),$()])}}});/**
 * tdesign v1.11.5
 * (c) 2025 tdesign
 * @license MIT
 */var Ee=fe(be);const U=J(),Ve=q("fileList",()=>{const s=g({url:"",surl:"",pwd:"",dir:"/",parse_password:""}),n=g(),f=g([]),m=()=>f.value.length===0?"/":f.value[f.value.length-2]??"/",k=async()=>{p.value=[];const v=await ve(s.value);n.value=v.data,s.value.dir!=="/"?n.value.list.unshift({category:-1,fs_id:0,is_dir:!0,local_ctime:0,local_mtime:0,server_ctime:0,server_mtime:0,size:0,md5:"",path:m(),server_filename:"返回上一层",dlink:""}):f.value=[]},t=g({token:localStorage.getItem("token")??"guest"}),x=g({count:0,size:0,expires_at:"1970-01-01 08:00:00"}),r=g(""),I=async()=>{var v,F;try{const d=await ge(t.value);x.value=d.data,r.value="",localStorage.setItem("token",t.value.token)}catch(d){const b=(F=(v=d==null?void 0:d.response)==null?void 0:v.data)==null?void 0:F.message;b&&(r.value=b)}},p=g([]),h=g([]),l=(v,F)=>{p.value=v,h.value=F.selectedRowData},u=g({hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""}),c=g(!1),o=g([]);return{GetFileListReq:s,GetFileListRes:n,getFileList:k,GetLimitReq:t,GetLimitRes:x,GetLimitError:r,getLimit:I,selectedRowKeys:p,handleSelectChange:l,getDownloadLinks:async(v,F)=>{var G,D,S;if(c.value)return _.error("正在解析中,请稍后再试"),!1;const{config:d}=U;v&&typeof v!="number"&&F&&(v.stopPropagation(),h.value=[F]);const b=[],$=h.value.filter(e=>(e.is_dir&&b.push(e.fs_id),e&&!e.is_dir));$.length!==h.value.length&&_.warning("暂时不支持解析文件夹"),h.value=$,p.value=p.value.filter(e=>!b.includes(e));const R=$.filter(e=>e.size>d.min_single_filesize);R.length!==$.length&&_.warning("文件过小不会被解析");const P=R.filter(e=>e.size<d.max_single_filesize);P.length!==R.length&&_.warning("文件过大不会被解析");const V=P;if(V.reduce((e,a)=>e+a.size,0)>d.max_all_filesize){_.error(`单次最多解析${ke(d.max_all_filesize)}的文件`);return}if(V.length>d.max_once){_.error(`单次最多解析${d.max_once}个文件`);return}if(V.length===0){_.error("满足要求的文件数量为0");return}try{if(c.value=!0,u.value.hit_captcha=!1,typeof v=="number"){const e=await M({randsk:n.value.randsk,uk:n.value.uk,shareid:n.value.shareid,fs_id:[v],surl:s.value.surl,dir:s.value.dir,pwd:s.value.pwd,token:t.value.token,parse_password:s.value.parse_password,vcode_str:u.value.vcode_str,vcode_input:u.value.vcode_input});return _.success("重新解析成功"),e.data}else{const e=[];let a=null,C;try{for(const A in V){C=V[A],a&&a.close(),a=await _.loading(`正在解析第${parseFloat(A)+1}个文件:${C.server_filename}`,9999999);const z=await M({randsk:n.value.randsk,uk:n.value.uk,shareid:n.value.shareid,fs_id:[C.fs_id],surl:s.value.surl,dir:s.value.dir,pwd:s.value.pwd,token:t.value.token,parse_password:s.value.parse_password,vcode_str:u.value.vcode_str,vcode_input:u.value.vcode_input});e.push(...z.data),C!==null&&(p.value=p.value.filter(N=>N!==C.fs_id),h.value=h.value.filter(N=>N.fs_id!==C.fs_id))}}catch(A){throw a&&a.close(),o.value=e,_.success("部分解析成功,下滑查看解析结果"),A}a&&a.close(),_.success("解析成功,下滑查看解析结果"),o.value=e}}catch(e){const a=e;if((S=(D=(G=a==null?void 0:a.response)==null?void 0:G.data)==null?void 0:D.message)!=null&&S.includes("-20")){const C=await me({parse_password:s.value.parse_password});u.value={hit_captcha:!0,...C.data,vcode_input:""}}else _.error("解析可能失败或超时了,请稍后前往历史记录中尝试查询是否成功")}finally{c.value=!1,await I(),await U.getConfig()}},GetDownLoadLinksRes:o,vcode:u,paths:f}}),B=Ve(),$e=J(),Ne=q("aria2",()=>{const s=g(!1),n=g({host:"ws://localhost:16800/jsonrpc",token:"",dir:""});O(()=>{const l=localStorage.getItem("aria2Config");l&&(n.value=JSON.parse(l))});const f=()=>s.value=!0,m=()=>s.value=!1,k=()=>{localStorage.setItem("aria2Config",JSON.stringify(n.value)),t=null};let t=null;const x=()=>new Promise((l,u)=>{t&&(t.close(),t=null);try{t=new WebSocket(n.value.host),t.onopen=()=>l(t),t.onerror=c=>{_.error("链接到Aria2下载器出错"),u(c)}}catch(c){_.error("链接到Aria2下载器出错"),u(c)}}),r=async(l,u=[])=>((!t||t.readyState!==WebSocket.OPEN)&&(t=await x()),new Promise((c,o)=>{t=t;const w="HkList"+Date.now().toString(),v={jsonrpc:"2.0",method:l,id:w,params:[`token:${n.value.token}`,...u]};t.onmessage=F=>{const d=JSON.parse(F.data);d.id===w&&(d.error?o(d.error):c(d.result))},t.send(JSON.stringify(v))})),I=async()=>{await r("aria2.getVersion"),_.success("测试连接成功")},p=async(l,u,c,o)=>{await r("aria2.addUri",[[l],{out:u,dir:n.value.dir===""?null:`${$e.config.name??"hklist"}/${n.value.dir}`,header:[`User-Agent: ${c}`],split:o.toString()}]),_.success("添加链接成功")};return{aria2ConfigDialogVisible:s,showAria2Config:f,hideAria2Config:m,aria2ConfigForm:n,saveAria2Config:k,getAria2Version:I,addAria2Url:p,downloadLinks:async(l,u=0)=>{Array.isArray(l)||(l=[l]);for(const c of l){let o=c.filename;if(c.fs_id&&B.GetFileListRes){const w=B.GetFileListRes.list.find(v=>v.fs_id===c.fs_id);w&&(o=w.path)}await p(c.urls[u],o,c.ua,16)}}}}),Me=H({__name:"Aria2Dialog",setup(s){const n=Ne(),{aria2ConfigDialogVisible:f,aria2ConfigForm:m}=pe(n),k={},t=async({validateResult:x})=>{x===!0&&(n.saveAria2Config(),n.hideAria2Config(),_.success("保存成功"))};return(x,r)=>{const I=Se,p=Fe,h=Le,l=ye,u=Ie,c=we;return he(),_e(c,{visible:L(f),"onUpdate:visible":r[3]||(r[3]=o=>Ce(f)?f.value=o:null),header:"Aria2配置调整",footer:!1},{default:y(()=>[i(u,{data:L(m),rules:k,onSubmit:t},{default:y(()=>[i(p,{label:"主机地址",name:"host",help:"需要包括协议,端口,地址"},{default:y(()=>[i(I,{modelValue:L(m).host,"onUpdate:modelValue":r[0]||(r[0]=o=>L(m).host=o)},null,8,["modelValue"])]),_:1}),i(p,{label:"密钥",name:"token"},{default:y(()=>[i(I,{modelValue:L(m).token,"onUpdate:modelValue":r[1]||(r[1]=o=>L(m).token=o)},null,8,["modelValue"])]),_:1}),i(p,{label:"保存路径",name:"dir"},{default:y(()=>[i(I,{modelValue:L(m).dir,"onUpdate:modelValue":r[2]||(r[2]=o=>L(m).dir=o)},null,8,["modelValue"])]),_:1}),i(p,null,{default:y(()=>[i(l,{size:"small"},{default:y(()=>[i(h,{theme:"default",onClick:L(n).hideAria2Config},{default:y(()=>r[4]||(r[4]=[T(" 取消 ")])),_:1},8,["onClick"]),i(h,{onClick:L(n).getAria2Version},{default:y(()=>r[5]||(r[5]=[T(" 测试连接 ")])),_:1},8,["onClick"]),i(h,{type:"submit"},{default:y(()=>r[6]||(r[6]=[T(" 保存 ")])),_:1})]),_:1})]),_:1})]),_:1},8,["data"])]),_:1},8,["visible"])}}});export{Ee as A,Me as _,Ne as a,Ve as u};
