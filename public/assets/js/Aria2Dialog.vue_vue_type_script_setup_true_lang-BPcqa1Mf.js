import{p as J,q as K,e as r,v as W,d as O,x as X,y as j,z as Q,A as Y,B as Z,C as ee,D as ae,E as ne,r as g,l as U,G as te,H as le,I as se,_ as oe,J as ie,K as re,L as ue,N as ce,O as de,u as fe,n as q,P as ve,Q as ge,M as p,R as M,S as _e,s as me,o as pe,a as Ce,b as y,f as L,g as T,T as he}from"./index-BIaFnYUc.js";import{f as we}from"./format-C8bCsiQU.js";import{I as ke,S as Fe}from"./index-D5kJdPPa.js";import{F as Ie,a as Se}from"./index-DOtWIM9n.js";import{B as ye}from"./useResizeObserver-IZAt_Bax.js";import{D as Le}from"./index-Dimxtgj1.js";/**
 * tdesign v1.10.6
 * (c) 2024 tdesign
 * @license MIT
 */function xe(){var l=W();return function(f,_){var w;if(J(l.props[f]))w=l.props[f](K);else if(l.slots[f])w=l.slots[f]&&l.slots[f](null)[0];else if(_){var t=_[l.props.theme];w=r(t,null,null)}return w}}/**
 * tdesign v1.10.6
 * (c) 2024 tdesign
 * @license MIT
 */var Ae={close:{type:[String,Boolean,Function],default:!1},default:{type:[String,Function]},icon:{type:Function},maxLine:{type:Number,default:0},message:{type:[String,Function]},operation:{type:Function},theme:{type:String,default:"info",validator:function(n){return["success","info","warning","error"].includes(n)}},title:{type:[String,Function]},onClose:Function,onClosed:Function};/**
 * tdesign v1.10.6
 * (c) 2024 tdesign
 * @license MIT
 */var be=O({name:"TAlert",props:Ae,setup:function(n){var f=X("alert"),_=f.globalConfig,w=f.classPrefix,t=j({CheckCircleFilledIcon:Q,CloseIcon:Y,ErrorCircleFilledIcon:Z,HelpCircleFilledIcon:ee,InfoCircleFilledIcon:ae}),x=t.CheckCircleFilledIcon,u=t.CloseIcon,I=t.ErrorCircleFilledIcon,m=t.HelpCircleFilledIcon,h=t.InfoCircleFilledIcon,s=ne("alert"),o=ce(),c=xe(),i=g(null),k=g(null),v=g(0),F=g(!0),d=g(!0),b=function(){var e={info:h,success:x,warning:I,error:I,question:m},a=c("icon",e);return a?r("div",{class:"".concat(s.value,"__icon")},[a]):null},R=function(){var e=n.close,a=null;return e===!0||e===""?a=r(u,null,null):ie(e)?a=e:a=c("close"),a?r("div",{class:"".concat(s.value,"__close"),onClick:G},[a]):null},D=function(){var e=o("title");return e?r("div",{class:"".concat(s.value,"__title")},[" ",e]):null},P=function(){var e=o("operation");return r("div",{class:"".concat(s.value,"__message")},[N(),e?r("div",{class:"".concat(s.value,"__operation")},[e]):null])},N=function(){var e,a;a=o("default"),a||(a=o("message"));var C=ue(a)?a.length:1,A=n.maxLine>0&&n.maxLine<C,z=(e=k.value)===null||e===void 0||(e=e.children[0])===null||e===void 0?void 0:e.offsetHeight;return A&&d.value?(a=a.slice(0,n.maxLine),z&&(k.value.style.height="".concat(v.value,"px"))):A&&z&&(k.value.style.height="".concat(z*(C-n.maxLine)+v.value,"px")),r("div",{class:"".concat(s.value,"__description"),ref:k},[A?a.map(function(V){return r("div",null,[V])}):a,A?r("div",{class:"".concat(s.value,"__collapse"),onClick:function(){d.value=!d.value}},[d.value?_.value.expandText:_.value.collapseText]):null])},E=function(){return r("div",{class:"".concat(s.value,"__content")},[D(),P()])},G=function(e){var a;(a=n.onClose)===null||a===void 0||a.call(n,{e}),re(i.value,"".concat(s.value,"--closing"))},$=function(e){var a=e.target===i.value;if(e.propertyName==="opacity"&&a){var C;F.value=!1,(C=n.onClosed)===null||C===void 0||C.call(n,{e})}};return U(function(){te(i.value,"transitionend",$),v.value=k.value.offsetHeight}),le(function(){se(i.value,"transitionend",$)}),function(){return r("div",{ref:i,class:["".concat(s.value),"".concat(s.value,"--").concat(n.theme),oe({},"".concat(w.value,"-is-hidden"),!F.value)]},[b(),E(),R()])}}});/**
 * tdesign v1.10.6
 * (c) 2024 tdesign
 * @license MIT
 */var Te=de(be);const B=fe(),Ne=q("fileList",()=>{const l=g({url:"",surl:"",pwd:"",dir:"/",parse_password:""}),n=g(),f=g([]),_=()=>f.value.length===0?"/":f.value[f.value.length-2]??"/",w=async()=>{m.value=[];const v=await ve(l.value);n.value=v.data,l.value.dir!=="/"?n.value.list.unshift({category:-1,fs_id:0,is_dir:!0,local_ctime:0,local_mtime:0,server_ctime:0,server_mtime:0,size:0,md5:"",path:_(),server_filename:"返回上一层",dlink:""}):f.value=[]},t=g({token:localStorage.getItem("token")??"guest"}),x=g({count:0,size:0,expires_at:"1970-01-01 08:00:00"}),u=g(""),I=async()=>{var v,F;try{const d=await ge(t.value);x.value=d.data,u.value="",localStorage.setItem("token",t.value.token)}catch(d){const b=(F=(v=d==null?void 0:d.response)==null?void 0:v.data)==null?void 0:F.message;b&&(u.value=b)}},m=g([]),h=g([]),s=(v,F)=>{m.value=v,h.value=F.selectedRowData},o=g({hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""}),c=g(!1),i=g([]);return{GetFileListReq:l,GetFileListRes:n,getFileList:w,GetLimitReq:t,GetLimitRes:x,GetLimitError:u,getLimit:I,selectedRowKeys:m,handleSelectChange:s,getDownloadLinks:async(v,F)=>{var G,$,S;if(c.value)return p.error("正在解析中,请稍后再试"),!1;const{config:d}=B;v&&typeof v!="number"&&F&&(v.stopPropagation(),h.value=[F]);const b=[],R=h.value.filter(e=>(e.is_dir&&b.push(e.fs_id),e&&!e.is_dir));R.length!==h.value.length&&p.warning("暂时不支持解析文件夹"),h.value=R,m.value=m.value.filter(e=>!b.includes(e));const D=R.filter(e=>e.size>d.min_single_filesize);D.length!==R.length&&p.warning("文件过小不会被解析");const P=D.filter(e=>e.size<d.max_single_filesize);P.length!==D.length&&p.warning("文件过大不会被解析");const N=P;if(N.reduce((e,a)=>e+a.size,0)>d.max_all_filesize){p.error(`单次最多解析${we(d.max_all_filesize)}的文件`);return}if(N.length>d.max_once){p.error(`单次最多解析${d.max_once}个文件`);return}if(N.length===0){p.error("满足要求的文件数量为0");return}try{if(c.value=!0,o.value.hit_captcha=!1,typeof v=="number"){const e=await M({randsk:n.value.randsk,uk:n.value.uk,shareid:n.value.shareid,fs_id:[v],surl:l.value.surl,dir:l.value.dir,pwd:l.value.pwd,token:t.value.token,parse_password:l.value.parse_password,...o.value.hit_captcha?{vcode_str:o.value.vcode_str,vcode_input:o.value.vcode_input}:{}});return p.success("重新解析成功"),e.data}else{const e=[];let a=null,C;try{for(const A in N){C=N[A],a&&a.close(),a=await p.loading(`正在解析第${parseFloat(A)+1}个文件:${C.server_filename}`,9999999);const z=await M({randsk:n.value.randsk,uk:n.value.uk,shareid:n.value.shareid,fs_id:[C.fs_id],surl:l.value.surl,dir:l.value.dir,pwd:l.value.pwd,token:t.value.token,parse_password:l.value.parse_password,...o.value.hit_captcha?{vcode_str:o.value.vcode_str,vcode_input:o.value.vcode_input}:{}});e.push(...z.data),C!==null&&(m.value=m.value.filter(V=>V!==C.fs_id),h.value=h.value.filter(V=>V.fs_id!==C.fs_id))}}catch(A){throw a&&a.close(),i.value=e,p.success("部分解析成功,下滑查看解析结果"),A}a&&a.close(),p.success("解析成功,下滑查看解析结果"),i.value=e}}catch(e){const a=e;if((S=($=(G=a==null?void 0:a.response)==null?void 0:G.data)==null?void 0:$.message)!=null&&S.includes("-20")){const C=await _e({parse_password:l.value.parse_password});o.value={hit_captcha:!0,...C.data,vcode_input:""}}else p.error("解析可能失败或超时了,请稍后前往历史记录中尝试查询是否成功")}finally{c.value=!1,await I(),await B.getConfig()}},GetDownLoadLinksRes:i,vcode:o,paths:f}}),H=Ne(),Re=q("aria2",()=>{const l=g(!1),n=g({host:"ws://localhost:16800/jsonrpc",token:"",dir:""});U(()=>{const s=localStorage.getItem("aria2Config");s&&(n.value=JSON.parse(s))});const f=()=>l.value=!0,_=()=>l.value=!1,w=()=>{localStorage.setItem("aria2Config",JSON.stringify(n.value)),t=null};let t=null;const x=()=>new Promise((s,o)=>{t&&(t.close(),t=null);try{t=new WebSocket(n.value.host),t.onopen=()=>s(t),t.onerror=c=>{p.error("链接到Aria2下载器出错"),o(c)}}catch(c){p.error("链接到Aria2下载器出错"),o(c)}}),u=async(s,o=[])=>((!t||t.readyState!==WebSocket.OPEN)&&(t=await x()),new Promise((c,i)=>{t=t;const k="HkList"+Date.now().toString(),v={jsonrpc:"2.0",method:s,id:k,params:[`token:${n.value.token}`,...o]};t.onmessage=F=>{const d=JSON.parse(F.data);d.id===k&&(d.error?i(d.error):c(d.result))},t.send(JSON.stringify(v))})),I=async()=>{await u("aria2.getVersion"),p.success("测试连接成功")},m=async(s,o,c,i)=>{await u("aria2.addUri",[[s],{out:o,dir:n.value.dir===""?null:n.value.dir,header:[`User-Agent: ${c}`],split:i.toString()}]),p.success("添加链接成功")};return{aria2ConfigDialogVisible:l,showAria2Config:f,hideAria2Config:_,aria2ConfigForm:n,saveAria2Config:w,getAria2Version:I,addAria2Url:m,downloadLinks:async(s,o=0)=>{for(const c of s){let i=c.filename;if(c.fs_id&&H.GetFileListRes){const k=H.GetFileListRes.list.find(v=>v.fs_id===c.fs_id);k&&(i=k.path)}await m(c.urls[o],i,c.ua,16)}}}}),Ee=O({__name:"Aria2Dialog",setup(l){const n=Re(),{aria2ConfigDialogVisible:f,aria2ConfigForm:_}=me(n),w={},t=async({validateResult:x})=>{x===!0&&(n.saveAria2Config(),n.hideAria2Config(),p.success("保存成功"))};return(x,u)=>{const I=ke,m=Ie,h=ye,s=Fe,o=Se,c=Le;return pe(),Ce(c,{visible:L(f),"onUpdate:visible":u[3]||(u[3]=i=>he(f)?f.value=i:null),header:"Aria2配置调整",footer:!1},{default:y(()=>[r(o,{data:L(_),rules:w,onSubmit:t},{default:y(()=>[r(m,{label:"主机地址",name:"host",help:"需要包括协议,端口,地址"},{default:y(()=>[r(I,{modelValue:L(_).host,"onUpdate:modelValue":u[0]||(u[0]=i=>L(_).host=i)},null,8,["modelValue"])]),_:1}),r(m,{label:"密钥",name:"token"},{default:y(()=>[r(I,{modelValue:L(_).token,"onUpdate:modelValue":u[1]||(u[1]=i=>L(_).token=i)},null,8,["modelValue"])]),_:1}),r(m,{label:"保存路径",name:"dir"},{default:y(()=>[r(I,{modelValue:L(_).dir,"onUpdate:modelValue":u[2]||(u[2]=i=>L(_).dir=i)},null,8,["modelValue"])]),_:1}),r(m,null,{default:y(()=>[r(s,{size:"small"},{default:y(()=>[r(h,{theme:"default",onClick:L(n).hideAria2Config},{default:y(()=>u[4]||(u[4]=[T(" 取消 ")])),_:1},8,["onClick"]),r(h,{onClick:L(n).getAria2Version},{default:y(()=>u[5]||(u[5]=[T(" 测试连接 ")])),_:1},8,["onClick"]),r(h,{type:"submit"},{default:y(()=>u[6]||(u[6]=[T(" 保存 ")])),_:1})]),_:1})]),_:1})]),_:1},8,["data"])]),_:1},8,["visible"])}}});export{Te as A,Ee as _,Re as a,Ne as u};
