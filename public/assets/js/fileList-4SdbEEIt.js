import{q as I,a as V,b as r,bU as B,bV as E,M as l,bW as G,bX as K}from"./index-CllZ6jfo.js";import{f as U}from"./format-hhPM9vph.js";const F=V(),H=I("fileList",()=>{const a=r({url:"",surl:"",pwd:"",dir:"/",parse_password:""}),n=r(),f=r([]),C=()=>f.value.length===0?"/":f.value[f.value.length-2]??"/",M=async()=>{u.value=[];const t=await B(a.value);n.value=t.data,a.value.dir!=="/"?n.value.list.unshift({category:-1,fs_id:0,is_dir:!0,local_ctime:0,local_mtime:0,server_ctime:0,server_mtime:0,size:0,md5:"",path:C(),server_filename:"返回上一层",dlink:""}):f.value=[]},g=r({token:localStorage.getItem("token")??"guest"}),x=r({count:0,size:0,expires_at:"1970-01-01 08:00:00"}),h=r(""),S=async()=>{var t,v;try{await F.getConfig();const i=await E(g.value);x.value=i.data,h.value="",localStorage.setItem("token",g.value.token)}catch(i){const _=(v=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:v.message;_&&(h.value=_)}},u=r([]),c=r([]),P=(t,v)=>{u.value=t,c.value=v.selectedRowData},d=r({hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""}),k=r(!1),L=r([]);return{GetFileListReq:a,GetFileListRes:n,getFileList:M,GetLimitReq:g,GetLimitRes:x,GetLimitError:h,getLimit:S,selectedRowKeys:u,handleSelectChange:P,getDownloadLinks:async(t,v)=>{var $,b,D;if(k.value)return l.error("正在解析中,请稍后再试"),!1;const{config:i}=F;t&&typeof t!="number"&&v&&(t.stopPropagation(),c.value=[v]);const _=[],m=c.value.filter(e=>(e.is_dir&&_.push(e.fs_id),e&&!e.is_dir));m.length!==c.value.length&&l.warning("暂时不支持解析文件夹"),c.value=m,u.value=u.value.filter(e=>!_.includes(e));const y=m.filter(e=>e.size>i.min_single_filesize);y.length!==m.length&&l.warning("文件过小不会被解析");const R=y.filter(e=>e.size<i.max_single_filesize);R.length!==y.length&&l.warning("文件过大不会被解析");const p=R;if(p.reduce((e,s)=>e+s.size,0)>i.max_all_filesize){l.error(`单次最多解析${U(i.max_all_filesize)}的文件`);return}if(p.length>i.max_once){l.error(`单次最多解析${i.max_once}个文件`);return}if(p.length===0){l.error("满足要求的文件数量为0");return}try{if(k.value=!0,d.value.hit_captcha=!1,typeof t=="number"){const e=await G({randsk:n.value.randsk,uk:n.value.uk,shareid:n.value.shareid,fs_id:[t],surl:a.value.surl,dir:a.value.dir,pwd:a.value.pwd,token:g.value.token,parse_password:a.value.parse_password,vcode_str:d.value.vcode_str,vcode_input:d.value.vcode_input});return l.success("重新解析成功"),e.data}else{const e=[];let s=null,o;try{for(const w in p){o=p[w],s&&s.close(),s=await l.loading(`正在解析第${parseFloat(w)+1}个文件:${o.server_filename}`,9999999);const q=await G({randsk:n.value.randsk,uk:n.value.uk,shareid:n.value.shareid,fs_id:[o.fs_id],surl:a.value.surl,dir:a.value.dir,pwd:a.value.pwd,token:g.value.token,parse_password:a.value.parse_password,vcode_str:d.value.vcode_str,vcode_input:d.value.vcode_input});e.push(...q.data),o!==null&&(u.value=u.value.filter(z=>z!==o.fs_id),c.value=c.value.filter(z=>z.fs_id!==o.fs_id))}}catch(w){throw s&&s.close(),L.value=e,l.success("部分解析成功,下滑查看解析结果"),w}s&&s.close(),l.success("解析成功,下滑查看解析结果"),L.value=e}}catch(e){const s=e;if((D=(b=($=s==null?void 0:s.response)==null?void 0:$.data)==null?void 0:b.message)!=null&&D.includes("-20")){const o=await K({parse_password:a.value.parse_password});d.value={hit_captcha:!0,...o.data,vcode_input:""}}else l.error("解析可能失败或超时了,请稍后前往历史记录中尝试查询是否成功")}finally{k.value=!1,await S(),await F.getConfig()}},GetDownLoadLinksRes:L,vcode:d,paths:f}});export{H as useFileListStore};
